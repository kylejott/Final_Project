---
title: '**The Finnish Top 0.4 Percent**: An Exploration of Top Tax Shares in Finland
  from 2009 to 2013'
author: "Kyle Ott and Cornelius Schneider"
date: "12 December 2014"
output:
  pdf_document:
    number_sections: yes
    toc: yes
bibliography:
- main1.bib
- packages1.bib
---
\pagebreak
```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
pkgs <- c('httr', 'dplyr', 'XML', 'ggplot2', 'stringr', 'car', 'devtools', 'rsdmx', 'stargazer', 'knitr', 'tidyr', 'reshape2', 'sandwich', 'lmtest', 'plm', 'Zelig' )
repmis::LoadandCite(pkgs, file = 'packages1.bib')

# set your working directory here
setwd("/Users/Kyle/Dropbox/!Fall_2014/Collab_Data/Final_Project/")

##################################
# Final Assignment: Data Science Course
# Kyle Ott & Cornelius Schneider
# December 12, 2014
##################################

# Load packages
library(httr)
library(dplyr)
library(XML)
library(ggplot2)
library(stringr)
library(car)
library(devtools)
library(rsdmx)
library(stargazer)
library(knitr)
library(tidyr)
library(reshape2)
library(sandwich)
library(lmtest)
library(plm)
library(Zelig)

load("all.RData")

class(all$year)

#changing the titles to english
all <- plyr::rename(x = all,
                           replace = c("Nimi" = "name",
                                       "Tulot yht" = "total_inc",
                                       "Verot" = "taxes_paid",
                                       "Suhde" = "ratio"
                                       ))
str(all)

#cleaning ratio
all$ratio2 <- str_sub(all$ratio, 1, 2)
summary(all$ratio2)
all$ratio3 <- as.numeric(all$ratio2, length=2)
summary(all$ratio3)

#cleaning taxes_paid
sub(' â¬ $', '',all$taxes_paid)
all$taxes_paid2 <- sub(' â¬$', '',all$taxes_paid)
all$taxes_paid3 <- str_trim(all$taxes_paid2)
all$taxes_paid4 <-sub(' ', '',all$taxes_paid3)
all$taxes_paid5 <-sub(' ', '',all$taxes_paid4)
all$taxes_paid6 <- as.numeric(all$taxes_paid5, length=9)
summary(all$taxes_paid6)

#cleaning total_inc
all$total_inc2 <- sub(' â¬$', '',all$total_inc)
all$total_inc3 <- str_trim(all$total_inc2)
all$total_inc4 <-sub(' ', '',all$total_inc3)
all$total_inc5 <-sub(' ', '',all$total_inc4)
all$total_inc6 <- as.numeric(all$total_inc5, length=13)
summary(all$total_inc6)

#dropping name and keeping rank in given year
all$name2 <- str_sub(all$name, 1, 5)
all$name3 <- sub('\\. ..$', '',all$name2)
all$name4 <- sub('\\. .$', '',all$name3)
all$name5 <- sub('\\. $', '',all$name4)
all$name6 <- sub('\\.$', '',all$name5)
all$name7 <- as.numeric(all$name6, length=5)
summary(all$name7)

#dropping name and keeping rank in given year
all$justname <- str_sub(all$name)
all$justname <- sub('^.*\\. ', '',all$name)

clean <- all[, (colnames(all) %in% c("justname", "name7", "total_inc6", "taxes_paid6", "ratio3", "year"))]
str(clean)
clean <- plyr::rename(x = clean,
                             replace = c("total_inc6" = "total_inc",
                                         "taxes_paid6" = "taxes_paid",
                                         "name7" = "rank",
                                         "ratio3" = "ratio"
                             ))
# add 1 to taxes paid if it is zero to avoid problems
clean$taxes_paid <- replace(clean$taxes_paid,clean$taxes_paid<=1, 1)

## preparing time series dataset

###creating net-of-tax

clean["net_of_tax"] <- 1-(clean$ratio/100)

clean2 <- group_by(clean, year)
clean <- mutate(clean2, avg_inc=mean(total_inc))
summary(clean$avg_inc)

# Create Year Dummies
clean <- within(clean, yr2009<-ifelse(year==2009, 1, 0))
clean <- within(clean, yr2010<-ifelse(year==2010, 1, 0))
clean <- within(clean, yr2011<-ifelse(year==2011, 1, 0))
clean <- within(clean, yr2012<-ifelse(year==2012, 1, 0))
clean <- within(clean, yr2013<-ifelse(year==2013, 1, 0))

#cleaned is the dataset we will use for time series analysis
cleaned <- clean
```

#Introduction

#Literature Review

#Dataset

#Methodology

#Results

```{r, inlcude=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

M1 <- lm(log(avg_inc) ~ log(net_of_tax), data = cleaned, na.action = NULL)
# we have strong autocorr, so we use newey-west SE's
# M1a <- coeftest(M1,vcov=NeweyWest)
# stargazer only prints newey west results of coeff and SE only, no other info
M2 <- lm(log(avg_inc) ~ log(net_of_tax) + year,data = cleaned, na.action = NULL)
# due to problems with martix calculations, we cannot run newey west SW for M2
# therefore, we will argue that our coefficients are right, but the SE will be different
# Create cleaner covariate labels
labels <- c('Elasticity', 'Time Trend')
```

Time Series Results 

```{r, results='asis', echo=FALSE, error=FALSE, warning=FALSE}
stargazer::stargazer(M1, M2, covariate.labels = labels,
                     title = 'Time Series Elasticities',
                     type = 'latex', header = FALSE)
```

Panel Result

```{r, inlcude=FALSE, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}

# from creating panel dataset
load("panelmodel3.RData")
  
#OLS
ols1 <- lm(log(dep) ~ log(indep), data=panelmodel3)
summary(ols1)
confint(ols1)
# Durbin-Watson test for autocorrelation
# dwt(ols1)
# we do not have strong autocorr

# panelmodel3$id2 <- as.character(panelmodel3$id2)
# still can't get the panel to run using id2, using justname from now on

# Fixed

fixed <- plm(log(dep) ~ log(indep), data=panelmodel3, index=c("justname", "year"), model="within")
# summary(fixed)
# confint(fixed)
# Testing for fixed effects, null: OLS better than fixed
# pFtest(fixed, ols1) 

#BP LM test of cross-sectional dependence
# pcdtest(fixed, test = c("lm"))
# yes cross-sectional dependence?

# testing for serial correlation
# pbgtest(fixed)
# yes serial correlation?

# testing for heterosk, BP test
# bptest(dep ~ indep + factor(justname), data = panelmodel3, studentize=F)

# Create cleaner covariate labels
labels2 <- c('Elasticity')
```

Why does the summary show up?

```{r, results='asis', echo=FALSE, error=FALSE, warning=FALSE}
stargazer::stargazer(ols1, fixed, covariate.labels = labels2,
                     title = 'Panel Elasticities',
                     type = 'latex', header = FALSE)
```

#Discussion

#Conclusion

#References
