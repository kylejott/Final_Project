---
title: '**The Finnish Top 0.4 Percent**: An Exploration of Top Tax Shares in Finland
  from 2009 to 2013'
author: "Kyle Ott and Cornelius Schneider"
date: "12 December 2014"
output:
  pdf_document:
    number_sections: yes
    toc: yes
bibliography:
- main1.bib
- packages1.bib
---
\pagebreak
```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
pkgs <- c('httr', 'dplyr', 'XML', 'ggplot2', 'stringr', 'car', 'devtools', 'rsdmx', 'stargazer', 'knitr', 'tidyr', 'reshape2', 'sandwich', 'lmtest', 'plm' )
repmis::LoadandCite(pkgs, file = 'packages1.bib')

# set your working directory here
setwd("/Users/Kyle/Dropbox/!Fall_2014/Collab_Data/Final_Project/")

##################################
# Final Assignment: Data Science Course
# Kyle Ott & Cornelius Schneider
# December 12, 2014
##################################

# Load packages
library(httr)
library(dplyr)
library(XML)
library(ggplot2)
library(stringr)
library(car)
library(devtools)
library(rsdmx)
library(stargazer)
library(knitr)
library(tidyr)
library(reshape2)
library(sandwich)
library(lmtest)
library(plm)

load("cleaned.RData")

```

#Introduction

#Literature Review

#Dataset
```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
cleaned2 <- group_by(cleaned, year)


obs_all <- tally(cleaned2)
t1_totinc <- summarise(cleaned2, mean1=mean(total_inc),median1=median(total_inc))
t1_tottax <- summarise(cleaned2, mean2=mean(taxes_paid),median2=median(taxes_paid))
t1_rat <- summarise(cleaned2, mean3=mean(ratio),median3=median(ratio))

t1a <- merge(obs_all, t1_totinc,
                  by = c('year'))
t1b <- merge(t1a, t1_tottax,
             by = c('year'))
t1c <- merge(t1b, t1_rat,
             by = c('year'))

obs_all_sum <- tally(cleaned)
t1_totinc_sum <- summarise(cleaned, mean1=mean(total_inc),median1=median(total_inc))
t1_tottax_sum <- summarise(cleaned, mean2=mean(taxes_paid),median2=median(taxes_paid))
t1_rat_sum <- summarise(cleaned, mean3=mean(ratio),median3=median(ratio))

obs_all_sum$year <- c('All')
t1_totinc_sum$year <- c('All')
t1_tottax_sum$year <- c('All')
t1_rat_sum$year <- c('All')

t1a_sum <- merge(obs_all_sum, t1_totinc_sum,
             by = c('year'))
t1b_sum <- merge(t1a_sum, t1_tottax_sum,
             by = c('year'))
t1c_sum <- merge(t1b_sum, t1_rat_sum,
             by = c('year'))

summarytableTS <- rbind(t1c, t1c_sum)
```

```{r, results='asis', echo=FALSE, error=FALSE, warning=FALSE}
knitr::kable(summarytableTS, align ='c', digits = 0, format='latex', 
             col.names=c("Year", "N", "Ave Inc (E)", "Med Inc (E)",
                         "Ave Paid (E)", "Med Paid (E)",
                         "Mean Tax (%)", "Med Tax (%)"))
```


#Methodology

#Results

```{r, inlcude=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

M1 <- lm(log(avg_inc) ~ log(net_of_tax), data = cleaned, na.action = NULL)
# we have strong autocorr, so we use newey-west SE's
# M1a <- coeftest(M1,vcov=NeweyWest)
# stargazer only prints newey west results of coeff and SE only, no other info
M2 <- lm(log(avg_inc) ~ log(net_of_tax) + year,data = cleaned, na.action = NULL)
# due to problems with martix calculations, we cannot run newey west SW for M2
# therefore, we will argue that our coefficients are right, but the SE will be different
# Create cleaner covariate labels
labels <- c('Elasticity', 'Time Trend')
```

Time Series Results 

```{r, results='asis', echo=FALSE, error=FALSE, warning=FALSE}
stargazer::stargazer(M1, M2, covariate.labels = labels,
                     title = 'Time Series Elasticities',
                     column.labels = c("Without Time Trend", "With Time Trend"),
                     dep.var.labels = c("Log of Average Taxable Income"),
                     type = 'latex', header = FALSE)
```

Panel Result

```{r, inlcude=FALSE, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}

# from creating panel dataset
load("panelmodel3.RData")
  
#OLS
ols1 <- lm(log(dep) ~ log(indep), data=panelmodel3)
summary(ols1)
confint(ols1)
# Durbin-Watson test for autocorrelation
# dwt(ols1)
# we do not have strong autocorr

# panelmodel3$id2 <- as.character(panelmodel3$id2)
# still can't get the panel to run using id2, using justname from now on

# Fixed

fixed <- plm(log(dep) ~ log(indep), data=panelmodel3, index=c("justname", "year"), model="within")
# summary(fixed)
# confint(fixed)
# Testing for fixed effects, null: OLS better than fixed
# pFtest(fixed, ols1) 

#BP LM test of cross-sectional dependence
# pcdtest(fixed, test = c("lm"))
# yes cross-sectional dependence?

# testing for serial correlation
# pbgtest(fixed)
# yes serial correlation?

# testing for heterosk, BP test
# bptest(dep ~ indep + factor(justname), data = panelmodel3, studentize=F)

# Create cleaner covariate labels
labels2 <- c('Elasticity')
```

Why does the summary show up?

```{r, results='asis', echo=FALSE, error=FALSE, warning=FALSE}
stargazer::stargazer(ols1, fixed, covariate.labels = labels2,
                     title = 'Panel Elasticities',
                     column.labels = c("Pooled OLS", "Within Estimator"),
                     dep.var.labels = c("Log of Average Taxable Income"),
                     type = 'latex', header = FALSE)
```

#Discussion

#Conclusion

#References
